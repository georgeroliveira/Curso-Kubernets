# =====================================================
# Lab 01 - Primeiro Workflow GitHub Actions
# MÃ³dulo 07 - CI/CD
# =====================================================
# Este Ã© seu primeiro workflow! Ele demonstra conceitos bÃ¡sicos
# como triggers, jobs, steps e variÃ¡veis.

name: ğŸš€ Meu Primeiro Workflow

# Quando este workflow serÃ¡ executado
on:
  # Trigger manual atravÃ©s da interface do GitHub
  workflow_dispatch:
    inputs:
      nome:
        description: 'Seu nome'
        required: true
        default: 'Estudante'
        type: string
      ambiente:
        description: 'Ambiente de deploy'
        required: true
        default: 'desenvolvimento'
        type: choice
        options:
          - desenvolvimento
          - staging
          - producao
      executar_testes:
        description: 'Executar testes?'
        required: false
        default: true
        type: boolean
  
  # Ao fazer push em branches especÃ­ficas
  push:
    branches: 
      - main
      - develop
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - '.gitignore'
  
  # Ao abrir ou atualizar Pull Request
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  
  # ExecuÃ§Ã£o agendada (cron)
  schedule:
    # Todos os dias Ã s 8h (UTC)
    - cron: '0 8 * * *'

# VariÃ¡veis globais disponÃ­veis em todos os jobs
env:
  WORKFLOW_VERSION: '1.0.0'
  DEFAULT_NODE_VERSION: '16'
  EMOJI: 'ğŸ‰'

# Jobs que serÃ£o executados
jobs:
  # =====================================================
  # Job 1: InformaÃ§Ãµes e SaudaÃ§Ã£o
  # =====================================================
  informacoes:
    name: ğŸ“Š Coletar InformaÃ§Ãµes
    runs-on: ubuntu-latest
    
    # Outputs que podem ser usados por outros jobs
    outputs:
      hora: ${{ steps.time.outputs.hora }}
      branch: ${{ steps.info.outputs.branch }}
      
    steps:
      # Step 1: Checkout do cÃ³digo
      - name: ğŸ“¥ Baixar cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Buscar todo histÃ³rico
      
      # Step 2: Exibir informaÃ§Ãµes do evento
      - name: â„¹ï¸ InformaÃ§Ãµes do Evento
        id: info
        run: |
          echo "ğŸ­ Evento: ${{ github.event_name }}"
          echo "ğŸ‘¤ Ator: ${{ github.actor }}"
          echo "ğŸ“¦ RepositÃ³rio: ${{ github.repository }}"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ’¼ Workflow: ${{ github.workflow }}"
          echo "ğŸ”¢ Run Number: ${{ github.run_number }}"
          echo "ğŸ†” Run ID: ${{ github.run_id }}"
          
          # Salvar branch como output
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
      
      # Step 3: Capturar horÃ¡rio
      - name: ğŸ• Capturar HorÃ¡rio
        id: time
        run: |
          HORA=$(TZ='America/Sao_Paulo' date '+%H:%M:%S %d/%m/%Y')
          echo "HorÃ¡rio: $HORA"
          echo "hora=$HORA" >> $GITHUB_OUTPUT
      
      # Step 4: SaudaÃ§Ã£o personalizada
      - name: ğŸ‘‹ SaudaÃ§Ã£o
        run: |
          NOME="${{ github.event.inputs.nome || 'Desenvolvedor' }}"
          echo "${{ env.EMOJI }} OlÃ¡, $NOME!"
          echo "Bem-vindo ao mundo do CI/CD com GitHub Actions!"
          
          # SaudaÃ§Ã£o baseada no horÃ¡rio
          HORA=$(date +%H)
          if [ $HORA -lt 12 ]; then
            echo "â˜€ï¸ Bom dia!"
          elif [ $HORA -lt 18 ]; then
            echo "â˜ï¸ Boa tarde!"
          else
            echo "ğŸŒ™ Boa noite!"
          fi
      
      # Step 5: Listar arquivos do repositÃ³rio
      - name: ğŸ“ Estrutura do RepositÃ³rio
        run: |
          echo "Arquivos no repositÃ³rio:"
          ls -la
          echo ""
          echo "Estrutura de diretÃ³rios:"
          find . -type d -name ".git" -prune -o -type d -print | head -20

  # =====================================================
  # Job 2: Setup e ValidaÃ§Ã£o
  # =====================================================
  setup:
    name: ğŸ”§ Setup e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: informacoes
    
    strategy:
      matrix:
        node-version: [14, 16, 18]
        os: [ubuntu-latest]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: ğŸ“‹ VersÃµes Instaladas
        run: |
          echo "Node version:"
          node --version
          echo "NPM version:"
          npm --version
          echo "Sistema Operacional:"
          uname -a
      
      - name: ğŸ“¦ Criar package.json de exemplo
        run: |
          if [ ! -f package.json ]; then
            cat > package.json <<EOF
          {
            "name": "meu-primeiro-workflow",
            "version": "1.0.0",
            "scripts": {
              "test": "echo 'Executando testes...' && exit 0",
              "build": "echo 'Construindo aplicaÃ§Ã£o...'",
              "lint": "echo 'Verificando cÃ³digo...'"
            },
            "devDependencies": {
              "jest": "^29.0.0"
            }
          }
          EOF
            echo "âœ… package.json criado"
          fi
      
      - name: ğŸ” Validar JSON
        run: |
          echo "Validando package.json..."
          node -e "JSON.parse(require('fs').readFileSync('package.json'))"
          echo "âœ… JSON vÃ¡lido!"

  # =====================================================
  # Job 3: Testes
  # =====================================================
  testes:
    name: ğŸ§ª Executar Testes
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.executar_testes != 'false'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.DEFAULT_NODE_VERSION }}
      
      - name: ğŸ§ª Simular Testes
        id: test
        run: |
          echo "Executando suÃ­te de testes..."
          echo "â–¶ï¸ Teste 1: ConexÃ£o... âœ…"
          sleep 1
          echo "â–¶ï¸ Teste 2: AutenticaÃ§Ã£o... âœ…"
          sleep 1
          echo "â–¶ï¸ Teste 3: API... âœ…"
          sleep 1
          echo "â–¶ï¸ Teste 4: Banco de dados... âœ…"
          
          # Simular resultado de testes
          PASSED=$((RANDOM % 10 + 90))
          FAILED=$((100 - PASSED))
          
          echo ""
          echo "ğŸ“Š Resultado dos Testes:"
          echo "âœ… Passou: $PASSED%"
          echo "âŒ Falhou: $FAILED%"
          echo "test_result=$PASSED" >> $GITHUB_OUTPUT
      
      - name: ğŸ“ˆ RelatÃ³rio de Cobertura
        run: |
          echo "Gerando relatÃ³rio de cobertura..."
          echo "ğŸ“Š Cobertura de CÃ³digo: 85%"
          echo "  â”œâ”€ src/: 90%"
          echo "  â”œâ”€ tests/: 100%"
          echo "  â””â”€ utils/: 75%"

  # =====================================================
  # Job 4: Build
  # =====================================================
  build:
    name: ğŸ—ï¸ Build da AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: testes
    if: always() && needs.testes.result != 'failure'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ğŸ³ Simular Build Docker
        run: |
          echo "FROM node:${{ env.DEFAULT_NODE_VERSION }}-alpine" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN echo 'Building app...'" >> Dockerfile
          echo "CMD [\"node\", \"index.js\"]" >> Dockerfile
          
          echo "ğŸ³ Dockerfile criado:"
          cat Dockerfile
          
          echo ""
          echo "Simulando build Docker..."
          echo "â–¶ï¸ Step 1/4 : FROM node:16-alpine"
          sleep 1
          echo "â–¶ï¸ Step 2/4 : WORKDIR /app"
          sleep 1
          echo "â–¶ï¸ Step 3/4 : COPY . ."
          sleep 1
          echo "â–¶ï¸ Step 4/4 : CMD [\"node\", \"index.js\"]"
          echo "âœ… Build concluÃ­do com sucesso!"
      
      - name: ğŸ“¦ Criar Artifacts
        run: |
          mkdir -p dist
          echo "console.log('Hello from CI/CD!');" > dist/app.js
          echo "Build version: ${{ github.run_number }}" > dist/version.txt
          echo "Built at: $(date)" >> dist/version.txt
          echo "Commit: ${{ github.sha }}" >> dist/version.txt
      
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ github.run_number }}
          path: dist/
          retention-days: 7

  # =====================================================
  # Job 5: Deploy Simulado
  # =====================================================
  deploy:
    name: ğŸš€ Deploy Simulado
    runs-on: ubuntu-latest
    needs: [informacoes, build]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    environment:
      name: ${{ github.event.inputs.ambiente || 'desenvolvimento' }}
      url: https://exemplo.com/${{ github.event.inputs.ambiente }}
    
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-${{ github.run_number }}
          path: ./dist
      
      - name: ğŸ“‹ Verificar Artifacts
        run: |
          echo "Arquivos recebidos:"
          ls -la dist/
          echo ""
          cat dist/version.txt
      
      - name: ğŸš€ Simular Deploy
        run: |
          AMBIENTE="${{ github.event.inputs.ambiente || 'desenvolvimento' }}"
          echo "ğŸ¯ Iniciando deploy para: $AMBIENTE"
          echo "ğŸ“ URL: https://exemplo.com/$AMBIENTE"
          
          # Simular etapas de deploy
          echo "â–¶ï¸ Conectando ao servidor..."
          sleep 2
          echo "â–¶ï¸ Enviando arquivos..."
          sleep 2
          echo "â–¶ï¸ Reiniciando serviÃ§os..."
          sleep 2
          echo "â–¶ï¸ Verificando saÃºde da aplicaÃ§Ã£o..."
          sleep 1
          echo "âœ… Deploy concluÃ­do com sucesso!"
      
      - name: ğŸ”” NotificaÃ§Ã£o
        run: |
          echo "ğŸ“§ Enviando notificaÃ§Ã£o..."
          echo "Para: team@exemplo.com"
          echo "Assunto: Deploy realizado - ${{ github.event.inputs.ambiente }}"
          echo "Mensagem: Deploy da versÃ£o ${{ github.run_number }} realizado com sucesso!"

  # =====================================================
  # Job 6: RelatÃ³rio Final
  # =====================================================
  relatorio:
    name: ğŸ“Š RelatÃ³rio Final
    runs-on: ubuntu-latest
    needs: [informacoes, setup, testes, build, deploy]
    if: always()
    
    steps:
      - name: ğŸ“ˆ Gerar RelatÃ³rio
        run: |
          echo "========================================="
          echo "         RELATÃ“RIO DO WORKFLOW"
          echo "========================================="
          echo ""
          echo "ğŸ“… Data/Hora: ${{ needs.informacoes.outputs.hora }}"
          echo "ğŸ”€ Branch: ${{ needs.informacoes.outputs.branch }}"
          echo "ğŸ‘¤ Executado por: ${{ github.actor }}"
          echo ""
          echo "ğŸ“Š Status dos Jobs:"
          echo "  âœ… InformaÃ§Ãµes: ${{ needs.informacoes.result }}"
          echo "  âœ… Setup: ${{ needs.setup.result }}"
          echo "  âœ… Testes: ${{ needs.testes.result }}"
          echo "  âœ… Build: ${{ needs.build.result }}"
          echo "  âœ… Deploy: ${{ needs.deploy.result }}"
          echo ""
          echo "========================================="
          echo "    Workflow concluÃ­do com sucesso!"
          echo "========================================="
      
      - name: ğŸ’¡ PrÃ³ximos Passos
        run: |
          echo ""
          echo "ğŸ“ ParabÃ©ns! VocÃª executou seu primeiro workflow!"
          echo ""
          echo "ğŸ“š PrÃ³ximos passos para aprender:"
          echo "1. Modificar os triggers (on:)"
          echo "2. Adicionar novos steps"
          echo "3. Usar secrets para dados sensÃ­veis"
          echo "4. Criar matriz de testes"
          echo "5. Configurar ambientes (environments)"
          echo "6. Adicionar aprovaÃ§Ãµes manuais"
          echo "7. Integrar com serviÃ§os externos"
          echo ""
          echo "ğŸ“– DocumentaÃ§Ã£o: https://docs.github.com/actions"

# =====================================================
# Como usar este workflow:
# 
# 1. Copie este arquivo para: .github/workflows/hello-world.yml
# 2. FaÃ§a commit e push para o repositÃ³rio
# 3. VÃ¡ atÃ© Actions no GitHub
# 4. Execute manualmente ou faÃ§a um push
# =====================================================
